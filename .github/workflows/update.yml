name: Update PIB Digest data

on:
  schedule:
    - cron: "0 */2 * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: pib-digest-update
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install requests beautifulsoup4 lxml

      - name: Build data
        run: |
          python scripts/build_data.py

      - name: Decide publish or skip (never fail)
        id: decide
        run: |
          python - << 'PY'
          import json, os

          path = "public/data/index.json"
          publish = False
          count = 0

          if os.path.exists(path):
              with open(path, "r", encoding="utf-8") as f:
                  data = json.load(f)
              count = int(data.get("count", 0))
              publish = count >= 1

          print("index.json count =", count)
          print("publish =", publish)

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as out:
              out.write(f"publish={'true' if publish else 'false'}\n")
              out.write(f"count={count}\n")
          PY

      - name: Commit & push (safe)
        if: steps.decide.outputs.publish == 'true'
        run: |
          git config user.name "pib-digest-bot"
          git config user.email "actions@users.noreply.github.com"

          git pull --rebase origin main

          git add public/data/index.json public/data/items
          git commit -m "chore: update pib digest data" || echo "No changes"
          git push origin main

      - name: Skip publish
        if: steps.decide.outputs.publish != 'true'
        run: |
          echo "Skipping publish because count=${{ steps.decide.outputs.count }}. Keeping previous production data."